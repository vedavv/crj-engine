<!DOCTYPE html>
<html lang="sa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRJ SoundScape | श्री चागण्टि रामयोगेश्वर ध्वनिलोकः</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Noto+Sans+Devanagari:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
@font-face {
  font-family: 'Vijaya';
  src: url('https://vedavishtaram.in/fonts/VIJAYADV.ttf') format('truetype');
}

:root {
  --deep-sacred: #0a0612;
  --twilight: #1a0f2e;
  --amber-glow: #d4a854;
  --warm-gold: #c5943a;
  --sacred-saffron: #e8a031;
  --flame-accent: #e87831;
  --lotus-pink: #c4607a;
  --sky-blue: #4a8fb8;
  --pale-gold: #f5e6c8;
  --muted-cream: #e8dcc8;
  --text-light: #e8e0d4;
  --text-muted: #9a8e7e;
  --card-bg: rgba(18, 12, 32, 0.85);
  --card-border: rgba(212, 168, 84, 0.15);
  --glass: rgba(255, 255, 255, 0.03);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  font-family: 'Cormorant Garamond', 'Noto Sans Devanagari', serif;
  background: var(--deep-sacred);
  color: var(--text-light);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ═══════════════════ COSMIC BACKGROUND ═══════════════════ */
.cosmos {
  position: fixed;
  inset: 0;
  z-index: 0;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(74, 40, 120, 0.15) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(200, 140, 50, 0.08) 0%, transparent 40%),
    radial-gradient(ellipse at 50% 80%, rgba(100, 50, 30, 0.1) 0%, transparent 50%),
    linear-gradient(180deg, #060310 0%, #0a0612 30%, #120a1e 60%, #0a0612 100%);
}

.cosmos::before {
  content: '';
  position: absolute;
  inset: 0;
  background-image:
    radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,0.4), transparent),
    radial-gradient(1px 1px at 30% 70%, rgba(255,255,255,0.3), transparent),
    radial-gradient(1.5px 1.5px at 50% 10%, rgba(212,168,84,0.5), transparent),
    radial-gradient(1px 1px at 70% 50%, rgba(255,255,255,0.35), transparent),
    radial-gradient(1px 1px at 90% 80%, rgba(255,255,255,0.3), transparent),
    radial-gradient(1.5px 1.5px at 15% 90%, rgba(212,168,84,0.4), transparent),
    radial-gradient(1px 1px at 85% 30%, rgba(255,255,255,0.25), transparent),
    radial-gradient(1px 1px at 45% 45%, rgba(255,255,255,0.2), transparent),
    radial-gradient(1px 1px at 65% 75%, rgba(255,255,255,0.3), transparent),
    radial-gradient(1.2px 1.2px at 25% 55%, rgba(232,160,49,0.35), transparent);
  animation: starTwinkle 8s ease-in-out infinite alternate;
}

@keyframes starTwinkle {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.7; }
}

/* ═══════════════════ MAIN CONTAINER ═══════════════════ */
.page-wrapper {
  position: relative;
  z-index: 1;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
  opacity: 0;
  transition: opacity 1s ease;
}

.page-wrapper.revealed {
  opacity: 1;
}

/* ═══════════════════ HEADER ═══════════════════ */
.site-header {
  text-align: center;
  padding: 50px 20px 30px;
  position: relative;
}

.om-symbol {
  font-size: 3.2rem;
  color: var(--amber-glow);
  text-shadow: 0 0 30px rgba(212, 168, 84, 0.4);
  animation: omPulse 4s ease-in-out infinite;
  display: block;
  margin-bottom: 10px;
}

@keyframes omPulse {
  0%, 100% { opacity: 0.7; text-shadow: 0 0 20px rgba(212, 168, 84, 0.3); }
  50% { opacity: 1; text-shadow: 0 0 40px rgba(212, 168, 84, 0.6), 0 0 80px rgba(212, 168, 84, 0.2); }
}

.site-title {
  font-family: 'Cinzel', serif;
  font-size: clamp(1.4rem, 3vw, 2.2rem);
  font-weight: 600;
  letter-spacing: 0.25em;
  color: var(--amber-glow);
  text-transform: uppercase;
  margin-bottom: 4px;
}

.site-subtitle-sa {
  font-family: 'Noto Sans Devanagari', 'Vijaya', serif;
  font-size: clamp(1.1rem, 2.5vw, 1.6rem);
  font-weight: 500;
  color: var(--pale-gold);
  margin-bottom: 8px;
  letter-spacing: 0.05em;
}

.site-desc {
  font-family: 'Cormorant Garamond', serif;
  font-size: 0.95rem;
  color: var(--text-muted);
  font-style: italic;
  letter-spacing: 0.1em;
}

.header-line {
  width: 200px;
  height: 1px;
  margin: 25px auto 0;
  background: linear-gradient(90deg, transparent, var(--amber-glow), transparent);
}

/* ═══════════════════ NAVIGATION BAR ═══════════════════ */
.nav-bar {
  display: flex;
  justify-content: center;
  gap: 6px;
  padding: 12px 0;
  flex-wrap: wrap;
  margin-bottom: 30px;
}

.nav-bar a {
  font-family: 'Cinzel', serif;
  font-size: 0.7rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text-muted);
  text-decoration: none;
  padding: 6px 14px;
  border: 1px solid rgba(212, 168, 84, 0.1);
  border-radius: 2px;
  transition: all 0.3s ease;
  background: rgba(255,255,255,0.02);
}

.nav-bar a:hover, .nav-bar a.active {
  color: var(--amber-glow);
  border-color: rgba(212, 168, 84, 0.4);
  background: rgba(212, 168, 84, 0.06);
}

/* ═══════════════════ HERO SECTION ═══════════════════ */
.hero {
  text-align: center;
  padding: 40px 20px 50px;
  position: relative;
}

.hero-badge {
  display: inline-block;
  font-family: 'Cinzel', serif;
  font-size: 0.65rem;
  letter-spacing: 0.35em;
  text-transform: uppercase;
  color: var(--sacred-saffron);
  border: 1px solid rgba(232, 160, 49, 0.3);
  padding: 5px 20px;
  margin-bottom: 25px;
  border-radius: 2px;
}

.hero h1 {
  font-family: 'Cinzel', serif;
  font-size: clamp(2rem, 5vw, 3.5rem);
  font-weight: 700;
  letter-spacing: 0.12em;
  color: var(--pale-gold);
  margin-bottom: 8px;
  line-height: 1.2;
}

.hero-sanskrit {
  font-family: 'Noto Sans Devanagari', 'Vijaya', serif;
  font-size: clamp(1.3rem, 3vw, 2rem);
  font-weight: 500;
  color: var(--amber-glow);
  margin-bottom: 15px;
  letter-spacing: 0.08em;
}

.hero-tagline {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem;
  color: var(--text-muted);
  font-style: italic;
  max-width: 600px;
  margin: 0 auto;
  line-height: 1.6;
}

/* Decorative mandala ring behind hero */
.mandala-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 400px;
  height: 400px;
  border: 1px solid rgba(212, 168, 84, 0.06);
  border-radius: 50%;
  pointer-events: none;
  animation: mandalaSpin 60s linear infinite;
}

.mandala-ring::after {
  content: '';
  position: absolute;
  inset: 30px;
  border: 1px solid rgba(212, 168, 84, 0.04);
  border-radius: 50%;
}

@keyframes mandalaSpin {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* ═══════════════════ SOUNDSCAPE PLAYER ═══════════════════ */
.player-section {
  margin-bottom: 40px;
}

.section-label {
  font-family: 'Cinzel', serif;
  font-size: 0.65rem;
  letter-spacing: 0.4em;
  text-transform: uppercase;
  color: var(--text-muted);
  text-align: center;
  margin-bottom: 20px;
}

.player-card {
  background:
    linear-gradient(135deg, rgba(26, 15, 46, 0.9), rgba(18, 12, 32, 0.95)),
    linear-gradient(45deg, rgba(212, 168, 84, 0.03), transparent);
  border: 1px solid var(--card-border);
  border-radius: 8px;
  padding: 40px;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
}

.player-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--amber-glow), transparent);
  opacity: 0.4;
}

/* Waveform visualization container */
.waveform-container {
  position: relative;
  height: 120px;
  margin-bottom: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border-radius: 6px;
  overflow: hidden;
  background: rgba(0,0,0,0.2);
}

.waveform-canvas {
  width: 100%;
  height: 100%;
  display: block;
}

.waveform-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, rgba(212, 168, 84, 0.1), transparent 30%, transparent 70%, rgba(212, 168, 84, 0.1));
  pointer-events: none;
}

.waveform-time {
  position: absolute;
  bottom: 6px;
  font-family: 'Cinzel', serif;
  font-size: 0.7rem;
  color: var(--text-muted);
  letter-spacing: 0.1em;
}

.waveform-time.current { left: 12px; color: var(--amber-glow); }
.waveform-time.total { right: 12px; }

/* Now Playing Info */
.now-playing {
  text-align: center;
  margin-bottom: 30px;
}

.track-number {
  font-family: 'Cinzel', serif;
  font-size: 0.6rem;
  letter-spacing: 0.4em;
  text-transform: uppercase;
  color: var(--sacred-saffron);
  margin-bottom: 6px;
}

.track-title-sa {
  font-family: 'Noto Sans Devanagari', 'Vijaya', serif;
  font-size: 1.6rem;
  font-weight: 600;
  color: var(--pale-gold);
  margin-bottom: 4px;
}

.track-title-en {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1rem;
  color: var(--text-muted);
  font-style: italic;
  letter-spacing: 0.1em;
}

/* Transport Controls */
.transport {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin-bottom: 30px;
}

.transport-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-muted);
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px;
}

.transport-btn:hover {
  color: var(--amber-glow);
}

.transport-btn svg {
  width: 22px;
  height: 22px;
  fill: currentColor;
}

.play-btn {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  border: 2px solid var(--amber-glow);
  background: rgba(212, 168, 84, 0.08);
  color: var(--amber-glow);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  position: relative;
}

.play-btn::before {
  content: '';
  position: absolute;
  inset: -6px;
  border-radius: 50%;
  border: 1px solid rgba(212, 168, 84, 0.15);
  transition: all 0.3s ease;
}

.play-btn:hover {
  background: rgba(212, 168, 84, 0.15);
  box-shadow: 0 0 30px rgba(212, 168, 84, 0.2);
}

.play-btn:hover::before {
  border-color: rgba(212, 168, 84, 0.3);
}

.play-btn svg {
  width: 26px;
  height: 26px;
  fill: currentColor;
  margin-left: 3px;
}

.play-btn.playing svg { margin-left: 0; }

/* Speed control */
.speed-control {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 25px;
}

.speed-label {
  font-family: 'Cinzel', serif;
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text-muted);
}

.speed-btns {
  display: flex;
  gap: 4px;
}

.speed-btn {
  font-family: 'Cinzel', serif;
  font-size: 0.65rem;
  padding: 4px 10px;
  border: 1px solid rgba(212, 168, 84, 0.15);
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  border-radius: 2px;
  transition: all 0.3s ease;
  letter-spacing: 0.05em;
}

.speed-btn:hover, .speed-btn.active {
  border-color: var(--amber-glow);
  color: var(--amber-glow);
  background: rgba(212, 168, 84, 0.08);
}

/* Volume Control */
.volume-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.volume-icon {
  color: var(--text-muted);
  cursor: pointer;
  transition: color 0.3s;
}

.volume-icon:hover { color: var(--amber-glow); }

.volume-icon svg { width: 18px; height: 18px; fill: currentColor; }

.volume-slider {
  -webkit-appearance: none;
  appearance: none;
  width: 120px;
  height: 2px;
  background: rgba(212, 168, 84, 0.2);
  border-radius: 1px;
  outline: none;
  cursor: pointer;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--amber-glow);
  cursor: pointer;
  border: none;
  box-shadow: 0 0 10px rgba(212, 168, 84, 0.3);
}

.volume-slider::-moz-range-thumb {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--amber-glow);
  cursor: pointer;
  border: none;
}

/* ═══════════════════ TRACK LIST ═══════════════════ */
.tracklist-section {
  margin-bottom: 50px;
}

.tracklist {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: 8px;
  overflow: hidden;
}

.track-item {
  display: grid;
  grid-template-columns: 40px 1fr auto auto;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-bottom: 1px solid rgba(212, 168, 84, 0.05);
  position: relative;
}

.track-item:last-child { border-bottom: none; }

.track-item:hover {
  background: rgba(212, 168, 84, 0.04);
}

.track-item.active {
  background: rgba(212, 168, 84, 0.06);
}

.track-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 2px;
  background: var(--amber-glow);
}

.track-idx {
  font-family: 'Cinzel', serif;
  font-size: 0.75rem;
  color: var(--text-muted);
  text-align: center;
  letter-spacing: 0.05em;
}

.track-item.active .track-idx {
  color: var(--amber-glow);
}

.track-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.track-name-sa {
  font-family: 'Noto Sans Devanagari', 'Vijaya', serif;
  font-size: 1.05rem;
  font-weight: 500;
  color: var(--text-light);
}

.track-item.active .track-name-sa {
  color: var(--pale-gold);
}

.track-name-en {
  font-family: 'Cormorant Garamond', serif;
  font-size: 0.8rem;
  color: var(--text-muted);
  font-style: italic;
}

.track-veda {
  font-family: 'Cinzel', serif;
  font-size: 0.55rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--sacred-saffron);
  opacity: 0.7;
  white-space: nowrap;
}

.track-dur {
  font-family: 'Cinzel', serif;
  font-size: 0.7rem;
  color: var(--text-muted);
  letter-spacing: 0.1em;
  min-width: 40px;
  text-align: right;
}

/* Playing indicator animation */
.playing-indicator {
  display: none;
  gap: 2px;
  align-items: flex-end;
  height: 14px;
}

.track-item.active.is-playing .playing-indicator {
  display: flex;
}

.track-item.active.is-playing .track-idx-text {
  display: none;
}

.playing-bar {
  width: 2px;
  background: var(--amber-glow);
  animation: barPulse 0.8s ease-in-out infinite;
  border-radius: 1px;
}

.playing-bar:nth-child(1) { height: 6px; animation-delay: 0s; }
.playing-bar:nth-child(2) { height: 10px; animation-delay: 0.15s; }
.playing-bar:nth-child(3) { height: 4px; animation-delay: 0.3s; }
.playing-bar:nth-child(4) { height: 8px; animation-delay: 0.45s; }

@keyframes barPulse {
  0%, 100% { transform: scaleY(0.5); }
  50% { transform: scaleY(1); }
}

/* ═══════════════════ ABOUT SECTION ═══════════════════ */
.about-section {
  text-align: center;
  padding: 40px 20px;
  margin-bottom: 40px;
}

.about-section h2 {
  font-family: 'Cinzel', serif;
  font-size: 0.65rem;
  letter-spacing: 0.4em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 20px;
}

.about-text {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.05rem;
  line-height: 1.8;
  color: var(--text-muted);
  max-width: 700px;
  margin: 0 auto;
}

.about-text .highlight {
  color: var(--pale-gold);
  font-weight: 600;
}

.sanskrit-verse {
  font-family: 'Noto Sans Devanagari', 'Vijaya', serif;
  font-size: 1.1rem;
  color: var(--amber-glow);
  margin: 20px 0;
  line-height: 2;
  font-weight: 500;
}

/* ═══════════════════ FOOTER ═══════════════════ */
.site-footer {
  text-align: center;
  padding: 40px 20px;
  border-top: 1px solid rgba(212, 168, 84, 0.08);
}

.footer-om {
  font-size: 1.5rem;
  color: var(--amber-glow);
  opacity: 0.5;
  margin-bottom: 12px;
}

.footer-text {
  font-family: 'Cinzel', serif;
  font-size: 0.6rem;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  color: var(--text-muted);
  opacity: 0.5;
}

.footer-sa {
  font-family: 'Noto Sans Devanagari', 'Vijaya', serif;
  font-size: 0.85rem;
  color: var(--text-muted);
  opacity: 0.4;
  margin-top: 8px;
}

/* ═══════════════════ RESPONSIVE ═══════════════════ */
@media (max-width: 768px) {
  .player-card { padding: 24px 16px; }
  .waveform-container { height: 80px; }
  .track-item {
    grid-template-columns: 30px 1fr auto;
    padding: 12px 16px;
    gap: 12px;
  }
  .track-veda { display: none; }
  .transport { gap: 14px; }
  .play-btn { width: 56px; height: 56px; }
  .mandala-ring { width: 280px; height: 280px; }
}

@media (max-width: 480px) {
  .site-header { padding: 30px 10px 20px; }
  .hero { padding: 20px 10px 30px; }
  .nav-bar a { font-size: 0.6rem; padding: 5px 10px; }
}

/* ═══════════════════ SPLASH SCREEN ═══════════════════ */
.splash-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background:
    radial-gradient(ellipse at 50% 40%, rgba(30, 50, 80, 0.6) 0%, transparent 60%),
    linear-gradient(180deg, #0b1628 0%, #14243d 40%, #1a2f4e 60%, #0e1a30 100%);
  overflow: hidden;
  transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.splash-overlay.dismiss {
  opacity: 0;
  transform: scale(1.08);
  pointer-events: none;
}

/* Cosmic dust particles behind emblem */
.splash-particles {
  position: absolute;
  inset: 0;
  overflow: hidden;
}

.splash-particle {
  position: absolute;
  width: 2px;
  height: 2px;
  border-radius: 50%;
  background: rgba(212, 185, 140, 0.5);
  animation: particleDrift 4s ease-in-out infinite;
}

.splash-particle:nth-child(1)  { left: 15%; top: 20%; animation-delay: 0s;   animation-duration: 3.5s; }
.splash-particle:nth-child(2)  { left: 80%; top: 15%; animation-delay: 0.3s; animation-duration: 4.2s; width: 1.5px; height: 1.5px; }
.splash-particle:nth-child(3)  { left: 25%; top: 75%; animation-delay: 0.6s; animation-duration: 3.8s; }
.splash-particle:nth-child(4)  { left: 70%; top: 65%; animation-delay: 0.9s; animation-duration: 4.5s; width: 3px; height: 3px; background: rgba(212, 168, 84, 0.4); }
.splash-particle:nth-child(5)  { left: 50%; top: 30%; animation-delay: 1.2s; animation-duration: 3.2s; }
.splash-particle:nth-child(6)  { left: 35%; top: 85%; animation-delay: 0.4s; animation-duration: 4.8s; width: 1px; height: 1px; }
.splash-particle:nth-child(7)  { left: 90%; top: 45%; animation-delay: 0.7s; animation-duration: 3.6s; }
.splash-particle:nth-child(8)  { left: 10%; top: 55%; animation-delay: 1.0s; animation-duration: 4.0s; width: 2.5px; height: 2.5px; background: rgba(212, 168, 84, 0.3); }
.splash-particle:nth-child(9)  { left: 60%; top: 90%; animation-delay: 0.2s; animation-duration: 3.4s; }
.splash-particle:nth-child(10) { left: 45%; top: 10%; animation-delay: 0.8s; animation-duration: 4.3s; }

@keyframes particleDrift {
  0%   { opacity: 0; transform: translateY(0) scale(0.5); }
  30%  { opacity: 1; }
  70%  { opacity: 0.8; }
  100% { opacity: 0; transform: translateY(-30px) scale(1.2); }
}

/* Golden aura behind emblem */
.splash-aura {
  position: absolute;
  width: 500px;
  height: 500px;
  border-radius: 50%;
  background:
    radial-gradient(circle, rgba(212, 168, 84, 0.12) 0%, rgba(212, 168, 84, 0.04) 40%, transparent 70%);
  animation: auraBreath 3s ease-in-out infinite alternate;
  pointer-events: none;
}

@keyframes auraBreath {
  0%   { transform: scale(0.85); opacity: 0.5; }
  100% { transform: scale(1.15); opacity: 1; }
}

/* Light rays radiating from center */
.splash-rays {
  position: absolute;
  width: 600px;
  height: 600px;
  opacity: 0;
  animation: raysAppear 2s ease-out 0.6s forwards;
  pointer-events: none;
}

.splash-rays::before,
.splash-rays::after {
  content: '';
  position: absolute;
  inset: 0;
  background:
    conic-gradient(
      from 0deg,
      transparent 0deg, rgba(212, 168, 84, 0.04) 15deg, transparent 30deg,
      transparent 60deg, rgba(212, 168, 84, 0.03) 75deg, transparent 90deg,
      transparent 120deg, rgba(212, 168, 84, 0.04) 135deg, transparent 150deg,
      transparent 180deg, rgba(212, 168, 84, 0.03) 195deg, transparent 210deg,
      transparent 240deg, rgba(212, 168, 84, 0.04) 255deg, transparent 270deg,
      transparent 300deg, rgba(212, 168, 84, 0.03) 315deg, transparent 330deg,
      transparent 360deg
    );
  animation: raysRotate 20s linear infinite;
}

.splash-rays::after {
  animation-direction: reverse;
  animation-duration: 25s;
  opacity: 0.7;
}

@keyframes raysAppear { to { opacity: 1; } }
@keyframes raysRotate { to { transform: rotate(360deg); } }

/* Emblem image */
.splash-emblem {
  position: relative;
  z-index: 2;
  width: min(340px, 70vw);
  opacity: 0;
  transform: scale(0.6);
  animation: emblemEmerge 1.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s forwards;
  filter: drop-shadow(0 0 40px rgba(212, 168, 84, 0.3)) drop-shadow(0 0 80px rgba(212, 168, 84, 0.1));
  border-radius: 12px;
}

@keyframes emblemEmerge {
  0%   { opacity: 0; transform: scale(0.6); filter: drop-shadow(0 0 0 transparent) brightness(0.3); }
  40%  { opacity: 1; filter: brightness(1.2) drop-shadow(0 0 60px rgba(212, 168, 84, 0.5)); }
  100% { opacity: 1; transform: scale(1); filter: drop-shadow(0 0 40px rgba(212, 168, 84, 0.3)) drop-shadow(0 0 80px rgba(212, 168, 84, 0.1)) brightness(1); }
}

/* Shimmer sweep across the emblem */
.splash-emblem-wrap {
  position: relative;
  z-index: 2;
  overflow: hidden;
  border-radius: 12px;
}

.splash-emblem-wrap::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -60%;
  width: 40%;
  height: 200%;
  background: linear-gradient(
    105deg,
    transparent 30%,
    rgba(255, 255, 255, 0.08) 45%,
    rgba(255, 255, 255, 0.15) 50%,
    rgba(255, 255, 255, 0.08) 55%,
    transparent 70%
  );
  transform: skewX(-15deg);
  animation: shimmerSweep 3s ease-in-out 1s forwards;
  pointer-events: none;
}

@keyframes shimmerSweep {
  0%   { left: -60%; opacity: 0; }
  20%  { opacity: 1; }
  100% { left: 160%; opacity: 0; }
}

/* Ring pulse effect */
.splash-ring {
  position: absolute;
  width: 280px;
  height: 280px;
  border: 1px solid rgba(212, 168, 84, 0.15);
  border-radius: 50%;
  z-index: 1;
  opacity: 0;
  animation: ringPulse 2.5s ease-out 0.8s forwards;
}

.splash-ring:nth-child(2) {
  width: 380px;
  height: 380px;
  border-color: rgba(212, 168, 84, 0.08);
  animation-delay: 1.1s;
  animation-duration: 3s;
}

@keyframes ringPulse {
  0%   { opacity: 0; transform: scale(0.5); }
  50%  { opacity: 1; }
  100% { opacity: 0; transform: scale(1.5); }
}

/* "Enter" prompt */
.splash-enter {
  position: relative;
  z-index: 2;
  margin-top: 30px;
  font-family: 'Cinzel', serif;
  font-size: 0.65rem;
  letter-spacing: 0.35em;
  text-transform: uppercase;
  color: rgba(212, 168, 84, 0.6);
  opacity: 0;
  animation: enterFade 1s ease 2.5s forwards;
  cursor: pointer;
  padding: 8px 24px;
  border: 1px solid rgba(212, 168, 84, 0.15);
  border-radius: 2px;
  background: transparent;
  transition: all 0.3s ease;
}

.splash-enter:hover {
  color: var(--amber-glow);
  border-color: rgba(212, 168, 84, 0.4);
  background: rgba(212, 168, 84, 0.06);
}

@keyframes enterFade {
  to { opacity: 1; }
}

/* ═══════════════════ SCROLL ANIMATIONS ═══════════════════ */
.fade-in {
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.8s ease forwards;
}

.fade-in:nth-child(2) { animation-delay: 0.15s; }
.fade-in:nth-child(3) { animation-delay: 0.3s; }

@keyframes fadeInUp {
  to { opacity: 1; transform: translateY(0); }
}

/* Loading state */
.loading-state {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 20px;
  color: var(--text-muted);
  font-family: 'Cormorant Garamond', serif;
  font-style: italic;
}

.loading-dot {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--amber-glow);
  animation: loadPulse 1.2s ease-in-out infinite;
}

.loading-dot:nth-child(2) { animation-delay: 0.2s; }
.loading-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes loadPulse {
  0%, 100% { opacity: 0.3; transform: scale(0.8); }
  50% { opacity: 1; transform: scale(1.2); }
}

/* Repeat toggle */
.repeat-btn.active { color: var(--amber-glow); }

/* ═══════════════════ ANALYSIS SECTION ═══════════════════ */
.analyze-card {
  background:
    linear-gradient(135deg, rgba(26, 15, 46, 0.9), rgba(18, 12, 32, 0.95)),
    linear-gradient(45deg, rgba(74, 143, 184, 0.03), transparent);
  border: 1px solid var(--card-border);
  border-radius: 8px;
  padding: 32px 40px;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
  margin-bottom: 16px;
}

.analyze-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--sky-blue), transparent);
  opacity: 0.3;
}

.analyze-card h2 {
  font-family: 'Cinzel', serif;
  font-size: 1.1rem;
  font-weight: 600;
  letter-spacing: 0.15em;
  color: var(--pale-gold);
  margin-bottom: 6px;
}

.analyze-card .desc {
  font-family: 'Cormorant Garamond', serif;
  font-size: 0.9rem;
  color: var(--text-muted);
  font-style: italic;
  margin-bottom: 20px;
}

/* Config */
.analyze-config {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  margin-bottom: 24px;
}

.a-field label {
  display: block;
  font-family: 'Cinzel', serif;
  font-size: 0.55rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.a-field select, .a-field input {
  width: 100%;
  padding: 9px 12px;
  border-radius: 4px;
  border: 1px solid var(--card-border);
  background: rgba(0,0,0,0.3);
  color: var(--text-light);
  font-family: 'Cormorant Garamond', serif;
  font-size: 0.9rem;
  appearance: none;
  -webkit-appearance: none;
  transition: border-color 0.3s;
}

.a-field select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239a8e7e' stroke-width='2.5' stroke-linecap='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 30px;
}

.a-field select:focus, .a-field input:focus {
  outline: none;
  border-color: var(--amber-glow);
}

/* Buttons */
.a-btn-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.a-btn {
  font-family: 'Cinzel', serif;
  font-size: 0.7rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  padding: 10px 24px;
  border: 1px solid var(--card-border);
  border-radius: 4px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  background: rgba(0,0,0,0.2);
  color: var(--text-light);
}

.a-btn:disabled { opacity: 0.3; cursor: default; }

.a-btn--record {
  border-color: rgba(200, 60, 60, 0.4);
  color: #e07070;
}
.a-btn--record:hover:not(:disabled) {
  background: rgba(200, 60, 60, 0.1);
  border-color: rgba(200, 60, 60, 0.6);
}
.a-btn--record.is-recording {
  animation: recBtnPulse 1.5s ease-in-out infinite;
}
@keyframes recBtnPulse {
  0%, 100% { box-shadow: none; }
  50% { box-shadow: 0 0 20px rgba(200, 60, 60, 0.3); }
}

.a-btn--stop {
  border-color: rgba(150, 150, 150, 0.3);
  color: var(--text-muted);
}

.a-btn--upload {
  border-color: rgba(212, 168, 84, 0.3);
  color: var(--amber-glow);
}
.a-btn--upload:hover {
  background: rgba(212, 168, 84, 0.06);
  border-color: rgba(212, 168, 84, 0.5);
}

/* Recording indicator */
.a-rec-bar {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 8px 14px;
  background: rgba(200, 60, 60, 0.06);
  border-radius: 4px;
  border: 1px solid rgba(200, 60, 60, 0.12);
  margin-bottom: 16px;
}
.a-rec-bar.active { display: flex; }

.a-rec-dot {
  width: 8px; height: 8px;
  background: #e07070;
  border-radius: 50%;
  animation: recordDotPulse 1s ease-in-out infinite;
}
@keyframes recordDotPulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.3; transform: scale(0.7); }
}

.a-rec-timer {
  font-family: 'Cinzel', serif;
  font-size: 0.75rem;
  color: #e07070;
  letter-spacing: 0.1em;
}

.a-rec-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-left: auto;
}

/* Mic waveform */
.a-waveform-wrap {
  border-radius: 6px;
  overflow: hidden;
  background: rgba(0,0,0,0.2);
  border: 1px solid var(--card-border);
  margin-bottom: 20px;
}

#a-waveform {
  display: block;
  width: 100%;
  height: 60px;
  background: transparent;
}

.a-status {
  font-family: 'Cormorant Garamond', serif;
  font-size: 0.85rem;
  color: var(--text-muted);
  min-height: 20px;
  margin-bottom: 10px;
}

.a-error {
  color: #e07070 !important;
  padding: 8px 12px;
  background: rgba(200, 60, 60, 0.06);
  border-left: 2px solid #e07070;
  border-radius: 0 4px 4px 0;
}

/* Processing */
.a-processing {
  text-align: center;
  padding: 30px 0;
}

.a-spinner {
  width: 48px; height: 48px;
  margin: 0 auto 16px;
  position: relative;
}

.a-spinner-ring {
  width: 100%; height: 100%;
  border-radius: 50%;
  border: 2px solid transparent;
  position: absolute;
  animation: spinRing 1.2s linear infinite;
}

.a-spinner-ring--1 { border-top-color: var(--amber-glow); animation-duration: 1.2s; }
.a-spinner-ring--2 { border-right-color: var(--sky-blue); animation-duration: 1.8s; animation-direction: reverse; }
.a-spinner-ring--3 { border-bottom-color: var(--lotus-pink); animation-duration: 2.4s; }

@keyframes spinRing { to { transform: rotate(360deg); } }

.a-progress {
  height: 3px;
  background: rgba(212, 168, 84, 0.08);
  border-radius: 2px;
  margin: 12px auto;
  max-width: 280px;
  overflow: hidden;
}

.a-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--warm-gold), var(--amber-glow), var(--sacred-saffron));
  width: 0%;
  border-radius: 2px;
  transition: width 0.5s ease;
}

.a-processing-msg {
  font-family: 'Cormorant Garamond', serif;
  font-size: 0.9rem;
  color: var(--text-muted);
  font-style: italic;
}

/* Results tabs */
.a-tabs {
  display: flex;
  gap: 3px;
  margin-bottom: 20px;
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
  padding: 3px;
  overflow-x: auto;
  border: 1px solid var(--card-border);
}

.a-tab {
  font-family: 'Cinzel', serif;
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  padding: 8px 14px;
  border: none;
  border-radius: 3px;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.a-tab:hover { color: var(--text-light); background: rgba(212, 168, 84, 0.04); }
.a-tab.active { color: var(--amber-glow); background: rgba(212, 168, 84, 0.08); }

.a-panel { display: none; animation: fadeInUp 0.3s ease; }
.a-panel.active { display: block; }

.a-panel h3 {
  font-family: 'Cinzel', serif;
  font-size: 0.6rem;
  letter-spacing: 0.3em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 12px;
}

/* Notation */
.a-notation-pre {
  font-family: 'Noto Sans Devanagari', monospace;
  font-size: 0.95rem;
  line-height: 2;
  white-space: pre-wrap;
  color: var(--sky-blue);
  background: rgba(0,0,0,0.2);
  padding: 16px 20px;
  border-radius: 6px;
  border: 1px solid var(--card-border);
}

/* Phrases */
.a-phrase {
  margin-bottom: 14px;
  padding: 14px 16px;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  border: 1px solid var(--card-border);
  transition: border-color 0.3s;
}
.a-phrase:hover { border-color: rgba(212, 168, 84, 0.3); }

.a-phrase-hdr {
  font-family: 'Cinzel', serif;
  font-size: 0.55rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.a-phrase-notes { display: flex; flex-wrap: wrap; gap: 5px; }

.a-swara {
  font-family: 'Noto Sans Devanagari', serif;
  font-size: 1rem;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 4px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.04);
  transition: all 0.2s;
  cursor: default;
  position: relative;
}
.a-swara:hover { background: rgba(255,255,255,0.07); transform: translateY(-2px); }
.a-swara.oct-low { border-bottom: 2px solid currentColor; padding-bottom: 2px; }
.a-swara.oct-high { border-top: 2px solid currentColor; padding-top: 2px; }

.a-swara .a-tip {
  display: none;
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%; transform: translateX(-50%);
  background: var(--twilight);
  border: 1px solid var(--card-border);
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 0.65rem;
  font-weight: 400;
  color: var(--text-muted);
  white-space: nowrap;
  z-index: 10;
  pointer-events: none;
}
.a-swara:hover .a-tip { display: block; }

/* Raga candidates */
.a-raga {
  display: grid;
  grid-template-columns: 32px 1fr 120px 44px;
  gap: 8px;
  align-items: center;
  padding: 12px 14px;
  margin-bottom: 6px;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  border: 1px solid var(--card-border);
  transition: all 0.3s;
}
.a-raga:hover { border-color: rgba(212, 168, 84, 0.3); transform: translateX(3px); }

.a-raga-rank {
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 6px;
  font-family: 'Cinzel', serif;
  font-weight: 700;
  font-size: 0.7rem;
}
.a-raga-rank--1 { background: rgba(212, 168, 84, 0.2); color: var(--amber-glow); }
.a-raga-rank--2 { background: rgba(150, 150, 150, 0.1); color: #bbb; }
.a-raga-rank--3 { background: rgba(140, 120, 100, 0.1); color: #a09080; }
.a-raga-rank--n { background: rgba(100, 100, 120, 0.08); color: var(--text-muted); }

.a-raga-name {
  font-family: 'Cinzel', serif;
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--pale-gold);
}
.a-raga-num {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-left: 6px;
}

.a-conf-bar { height: 5px; background: rgba(212, 168, 84, 0.06); border-radius: 3px; overflow: hidden; }
.a-conf-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--warm-gold), var(--amber-glow)); transition: width 1s ease; }
.a-conf-pct { font-family: 'Cinzel', serif; font-size: 0.7rem; color: var(--amber-glow); text-align: right; }

.a-raga-scale {
  grid-column: 2 / -1;
  font-family: monospace;
  font-size: 0.7rem;
  color: var(--sky-blue);
  opacity: 0.6;
}

/* Gamaka */
.a-gamaka-row { display: flex; gap: 8px; flex-wrap: wrap; }
.a-gamaka-item {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  border: 1px solid var(--card-border);
  min-width: 130px;
  transition: all 0.3s;
}
.a-gamaka-item:hover { border-color: rgba(212, 168, 84, 0.3); }
.a-gamaka-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.a-gamaka-name { font-weight: 600; font-size: 0.85rem; color: var(--text-light); }
.a-gamaka-count { font-size: 0.7rem; color: var(--text-muted); }

/* Summary */
.a-summary {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}
.a-sum-item {
  padding: 14px;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  border: 1px solid var(--card-border);
  text-align: center;
}
.a-sum-label {
  font-family: 'Cinzel', serif;
  font-size: 0.5rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 4px;
  display: block;
}
.a-sum-value {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--amber-glow);
}

/* Contour canvas */
.a-contour-wrap {
  border-radius: 6px;
  overflow: hidden;
  background: rgba(0,0,0,0.2);
  border: 1px solid var(--card-border);
}
#a-contour { display: block; width: 100%; height: 180px; }

.a-new-btn {
  margin-top: 20px;
}

/* Analysis responsive */
@media (max-width: 768px) {
  .analyze-card { padding: 24px 16px; }
  .analyze-config { grid-template-columns: 1fr 1fr; }
  .a-summary { grid-template-columns: 1fr 1fr; }
  .a-raga { grid-template-columns: 28px 1fr 90px 36px; font-size: 0.8rem; }
}

@media (max-width: 480px) {
  .analyze-config { grid-template-columns: 1fr; }
  .a-summary { grid-template-columns: 1fr; }
  .a-btn-row { flex-direction: column; }
  .a-btn { width: 100%; justify-content: center; }
}
</style>
</head>
<body>

<!-- ═══════ SPLASH SCREEN ═══════ -->
<div class="splash-overlay" id="splashOverlay">
  <div class="splash-particles">
    <span class="splash-particle"></span>
    <span class="splash-particle"></span>
    <span class="splash-particle"></span>
    <span class="splash-particle"></span>
    <span class="splash-particle"></span>
    <span class="splash-particle"></span>
    <span class="splash-particle"></span>
    <span class="splash-particle"></span>
    <span class="splash-particle"></span>
    <span class="splash-particle"></span>
  </div>
  <div class="splash-rays"></div>
  <div class="splash-aura"></div>
  <div class="splash-ring"></div>
  <div class="splash-ring"></div>
  <div class="splash-emblem-wrap">
    <img src="/images/crj-emblem.jpg" alt="CRJ Studio" class="splash-emblem">
  </div>
  <button class="splash-enter" id="splashEnter">Enter SoundScape</button>
</div>

<div class="cosmos"></div>

<div class="page-wrapper">

  <!-- HEADER -->
  <header class="site-header fade-in">
    <span class="om-symbol">&#x0950;</span>
    <h2 class="site-title">Veda Vij&#xF1;&#x101;na Vi&#x1E63;&#x1E6D;aram</h2>
    <div class="site-subtitle-sa">&#x0935;&#x0947;&#x0926; &#x0935;&#x093F;&#x091C;&#x094D;&#x091E;&#x093E;&#x0928; &#x0935;&#x093F;&#x0937;&#x094D;&#x091F;&#x0930;&#x092E;&#x094D;</div>
    <p class="site-desc">An Institution of Eminence for Vedic Education</p>
    <div class="header-line"></div>
  </header>

  <!-- NAVIGATION -->
  <nav class="nav-bar fade-in">
    <a href="https://vedavishtaram.in/">Home</a>
    <a href="https://vedavishtaram.in/crj/">CRJ</a>
    <a href="#" class="active">SoundScape</a>
    <a href="#playback-section">Play & Analyze</a>
  </nav>

  <!-- HERO -->
  <section class="hero fade-in">
    <div class="mandala-ring"></div>
    <div class="hero-badge">Sacred Audio Archive</div>
    <h1>CRJ SoundScape</h1>
    <div class="hero-sanskrit">&#x0927;&#x094D;&#x0935;&#x0928;&#x093F;&#x0932;&#x094B;&#x0915;&#x0903;</div>
    <p class="hero-tagline">
      A curated collection of sacred Vedic recitations &#x2014; S&#x101;maveda Setu,
      Mantras, and devotional hymns &#x2014; preserved in memory of
      &#x0936;&#x094D;&#x0930;&#x0940; &#x091A;&#x093E;&#x0917;&#x0923;&#x094D;&#x091F;&#x093F; &#x0930;&#x093E;&#x092E;&#x092F;&#x094B;&#x0917;&#x0947;&#x0936;&#x094D;&#x0935;&#x0930;&#x0930;&#x093E;&#x0935;
    </p>
  </section>

  <!-- PLAYER -->
  <section id="playback-section" class="player-section fade-in">
    <div class="section-label">Now Listening</div>
    <div class="player-card">

      <div class="waveform-container" id="waveformContainer">
        <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
        <div class="waveform-overlay"></div>
        <span class="waveform-time current" id="currentTime">0:00</span>
        <span class="waveform-time total" id="totalTime">0:00</span>
      </div>

      <div class="now-playing">
        <div class="track-number" id="trackNumber">Track 1 of 6</div>
        <div class="track-title-sa" id="trackTitleSa">&#x0938;&#x093E;&#x092E;&#x0935;&#x0947;&#x0926; &#x2014; &#x0938;&#x0947;&#x0924;&#x0941;&#x0903; &#x0967;</div>
        <div class="track-title-en" id="trackTitleEn">S&#x101;maveda &#x2014; Setu 1</div>
      </div>

      <div class="transport">
        <button class="transport-btn" id="prevBtn" title="Previous">
          <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
        </button>
        <button class="transport-btn" id="rewindBtn" title="Rewind 10s">
          <svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/><text x="10" y="16" font-size="7" fill="currentColor" text-anchor="middle" font-family="sans-serif">10</text></svg>
        </button>
        <button class="play-btn" id="playBtn" title="Play">
          <svg id="playIcon" viewBox="0 0 24 24"><polygon points="8,5 19,12 8,19"/></svg>
          <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
        </button>
        <button class="transport-btn" id="forwardBtn" title="Forward 10s">
          <svg viewBox="0 0 24 24"><path d="M12 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6h2c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8z"/><text x="14" y="16" font-size="7" fill="currentColor" text-anchor="middle" font-family="sans-serif">10</text></svg>
        </button>
        <button class="transport-btn" id="nextBtn" title="Next">
          <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
        </button>
      </div>

      <div class="speed-control">
        <span class="speed-label">Speed</span>
        <div class="speed-btns">
          <button class="speed-btn" data-speed="0.5">0.5x</button>
          <button class="speed-btn" data-speed="0.75">0.75x</button>
          <button class="speed-btn active" data-speed="1">1x</button>
          <button class="speed-btn" data-speed="1.25">1.25x</button>
          <button class="speed-btn" data-speed="1.5">1.5x</button>
        </div>
      </div>

      <div class="volume-row">
        <span class="volume-icon" id="volumeIcon">
          <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
        </span>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80">
        <button class="transport-btn repeat-btn" id="repeatBtn" title="Repeat">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" fill="currentColor"/></svg>
        </button>
      </div>
    </div>
  </section>

  <!-- TRACK LIST -->
  <section class="tracklist-section fade-in">
    <div class="section-label">Sacred Recitations</div>
    <div class="tracklist" id="tracklist"></div>
  </section>

  <!-- ═══════ ANALYZE ═══════ -->
  <section id="analyze-section" class="player-section fade-in" style="margin-top:10px">
    <div class="section-label">Swara Analysis</div>

    <!-- Input card: record / upload -->
    <div class="analyze-card" id="a-input-card">
      <h2>Record or Upload</h2>
      <p class="desc">Record from microphone (max 30s) or upload a file. Listen back, then submit for analysis.</p>

      <div class="a-btn-row">
        <button class="a-btn a-btn--record" id="a-btn-record">&#9679; Record</button>
        <button class="a-btn a-btn--stop" id="a-btn-stop" disabled>&#9632; Stop</button>
        <label class="a-btn a-btn--upload">
          &#128193; Upload File
          <input type="file" id="a-file-input" accept="audio/*,.webm" hidden>
        </label>
      </div>

      <div class="a-rec-bar" id="a-rec-bar">
        <span class="a-rec-dot"></span>
        <span class="a-rec-timer" id="a-rec-timer">0.0 s</span>
        <span class="a-rec-label">/ 30 s max</span>
      </div>

      <div id="a-status" class="a-status"></div>

      <div class="a-waveform-wrap">
        <canvas id="a-waveform" width="860" height="60"></canvas>
      </div>
    </div>

    <!-- Settings + Submit card -->
    <div class="analyze-card" id="a-settings-card" style="display:none">
      <h2>Analysis Settings</h2>
      <p class="desc">Configure and submit your audio for swara, raga, and gamaka detection.</p>

      <div class="analyze-config">
        <div class="a-field">
          <label for="a-sa">Reference Sa</label>
          <select id="a-sa"></select>
        </div>
        <div class="a-field">
          <label for="a-algo">Algorithm</label>
          <select id="a-algo">
            <option value="pyin" selected>pYIN (fast)</option>
            <option value="crepe">CREPE (accurate)</option>
          </select>
        </div>
        <div class="a-field">
          <label for="a-script">Script</label>
          <select id="a-script">
            <option value="iast" selected>IAST (Roman)</option>
            <option value="devanagari">Devanagari</option>
            <option value="kannada">Kannada</option>
            <option value="tamil">Tamil</option>
            <option value="telugu">Telugu</option>
          </select>
        </div>
        <div class="a-field">
          <label for="a-source">Source</label>
          <select id="a-source">
            <option value="vocal" selected>Vocal</option>
            <option value="instrument">Instrument</option>
          </select>
        </div>
      </div>

      <div class="a-btn-row">
        <button class="a-btn a-btn--upload" id="a-btn-submit">&#10148; Submit for Analysis</button>
        <button class="a-btn" id="a-btn-discard">&#215; Discard</button>
      </div>
    </div>

    <!-- Processing card -->
    <div class="analyze-card" id="a-proc-card" style="display:none">
      <div class="a-processing">
        <div class="a-spinner">
          <div class="a-spinner-ring a-spinner-ring--1"></div>
          <div class="a-spinner-ring a-spinner-ring--2"></div>
          <div class="a-spinner-ring a-spinner-ring--3"></div>
        </div>
        <div class="a-progress">
          <div class="a-progress-fill" id="a-progress-fill"></div>
        </div>
        <p class="a-processing-msg" id="a-proc-msg">Preparing audio&#8230;</p>
      </div>
    </div>

    <!-- Results card -->
    <div class="analyze-card" id="a-results-card" style="display:none">
      <h2>Analysis Results</h2>

      <div class="a-tabs" id="a-tabs">
        <button class="a-tab active" data-panel="ap-summary">Summary</button>
        <button class="a-tab" data-panel="ap-notation">Notation</button>
        <button class="a-tab" data-panel="ap-phrases">Phrases</button>
        <button class="a-tab" data-panel="ap-ragas">Ragas</button>
        <button class="a-tab" data-panel="ap-gamakas">Gamakas</button>
        <button class="a-tab" data-panel="ap-contour">Contour</button>
      </div>

      <div class="a-panel active" id="ap-summary">
        <div id="a-summary"></div>
        <div style="margin-top:16px">
          <h3>Compact Notation</h3>
          <div id="a-notation-compact"></div>
        </div>
      </div>

      <div class="a-panel" id="ap-notation">
        <h3>Full Notation</h3>
        <div id="a-notation-full"></div>
      </div>

      <div class="a-panel" id="ap-phrases">
        <h3>Swara Phrases</h3>
        <div id="a-phrases"></div>
      </div>

      <div class="a-panel" id="ap-ragas">
        <h3>Raga Identification</h3>
        <div id="a-ragas"></div>
      </div>

      <div class="a-panel" id="ap-gamakas">
        <h3>Gamakas Detected</h3>
        <div id="a-gamakas"></div>
      </div>

      <div class="a-panel" id="ap-contour">
        <h3>Pitch Contour</h3>
        <div class="a-contour-wrap">
          <canvas id="a-contour" width="860" height="180"></canvas>
        </div>
      </div>

      <div class="a-btn-row a-new-btn">
        <button class="a-btn a-btn--upload" id="a-btn-new">&#9654; New Analysis</button>
      </div>
    </div>
  </section>

  <!-- ABOUT -->
  <section class="about-section fade-in">
    <h2>About This Collection</h2>
    <div class="sanskrit-verse">
      &#x0917;&#x093E;&#x092F;&#x0924;&#x094D;&#x0930;&#x0940; &#x091B;&#x0928;&#x094D;&#x0926;&#x0938;&#x093E;&#x092E;&#x0939;&#x092E;&#x094D;<br>
      &#x2014; &#x0936;&#x094D;&#x0930;&#x0940;&#x092E;&#x0926;&#x094D;&#x092D;&#x0917;&#x0935;&#x0926;&#x094D;&#x0917;&#x0940;&#x0924;&#x093E; &#x0967;&#x0966;.&#x0969;&#x096B;
    </div>
    <p class="about-text">
      This <span class="highlight">SoundScape</span> preserves sacred Vedic recitations
      from the tradition of <span class="highlight">S&#x101;maveda</span> &#x2014; the Veda of Melody.
      Each Setu (&#x0938;&#x0947;&#x0924;&#x0941;&#x0903;) represents a bridge between the human voice and the divine,
      carrying forward an unbroken oral tradition spanning millennia.
      Curated by <span class="highlight">Dr. Vamshi Krishna Ghanapaathi</span>
      (&#x0935;&#x0947;&#x0926;&#x0928;&#x093F;&#x0927;&#x093F;, &#x0935;&#x093E;&#x091A;&#x0938;&#x094D;&#x092A;&#x0924;&#x093F;) in loving memory of
      <span class="highlight">&#x0936;&#x094D;&#x0930;&#x0940; &#x091A;&#x093E;&#x0917;&#x0923;&#x094D;&#x091F;&#x093F; &#x0930;&#x093E;&#x092E;&#x092F;&#x094B;&#x0917;&#x0947;&#x0936;&#x094D;&#x0935;&#x0930;&#x0930;&#x093E;&#x0935;</span>.
    </p>
  </section>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-om">&#x0950;</div>
    <div class="footer-text">Veda Vij&#xF1;&#x101;na Vi&#x1E63;&#x1E6D;aram &#x2014; CRJ SoundScape</div>
    <div class="footer-sa">&#xA9; &#x0935;&#x0947;&#x0926; &#x0935;&#x093F;&#x091C;&#x094D;&#x091E;&#x093E;&#x0928; &#x0935;&#x093F;&#x0937;&#x094D;&#x091F;&#x0930;&#x092E;&#x094D; &#x0968;&#x0966;&#x0968;&#x096C;</div>
  </footer>

</div>

<audio id="audioPlayer" preload="auto"></audio>

<script>
const TRACKS = [
  {
    id: 1,
    titleSa: "\u0938\u093E\u092E\u0935\u0947\u0926 \u2014 \u0938\u0947\u0924\u0941\u0903 \u0967",
    titleEn: "S\u0101maveda \u2014 Setu 1",
    veda: "S\u0101maveda",
    src: "/audio/Sama_1_Setu.m4a",
    duration: "0:30"
  },
  {
    id: 2,
    titleSa: "\u0938\u093E\u092E\u0935\u0947\u0926 \u2014 \u0938\u0947\u0924\u0941\u0903 \u0968",
    titleEn: "S\u0101maveda \u2014 Setu 2",
    veda: "S\u0101maveda",
    src: "",
    duration: "\u2014"
  },
  {
    id: 3,
    titleSa: "\u0938\u093E\u092E\u0935\u0947\u0926 \u2014 \u0938\u0947\u0924\u0941\u0903 \u0969",
    titleEn: "S\u0101maveda \u2014 Setu 3",
    veda: "S\u0101maveda",
    src: "",
    duration: "\u2014"
  },
  {
    id: 4,
    titleSa: "\u090B\u0917\u094D\u0935\u0947\u0926 \u092E\u0928\u094D\u0924\u094D\u0930\u093E\u0903",
    titleEn: "\u1E5Agveda Mantras",
    veda: "\u1E5Agveda",
    src: "",
    duration: "\u2014"
  },
  {
    id: 5,
    titleSa: "\u092F\u091C\u0941\u0930\u094D\u0935\u0947\u0926 \u092A\u094D\u0930\u0936\u0938\u094D\u0924\u093F\u0903",
    titleEn: "Yajurveda Recitation",
    veda: "Yajurveda",
    src: "",
    duration: "\u2014"
  },
  {
    id: 6,
    titleSa: "\u092D\u0915\u094D\u0924\u093F\u092A\u0926\u092E\u094D",
    titleEn: "Devotional Hymn",
    veda: "Bhakti",
    src: "",
    duration: "\u2014"
  }
];

let currentTrackIdx = 0;
let isPlaying = false;
let isRepeat = false;

const audio = document.getElementById('audioPlayer');
const playBtn = document.getElementById('playBtn');
const playIcon = document.getElementById('playIcon');
const pauseIcon = document.getElementById('pauseIcon');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const rewindBtn = document.getElementById('rewindBtn');
const forwardBtn = document.getElementById('forwardBtn');
const repeatBtn = document.getElementById('repeatBtn');
const currentTimeEl = document.getElementById('currentTime');
const totalTimeEl = document.getElementById('totalTime');
const trackNumber = document.getElementById('trackNumber');
const trackTitleSa = document.getElementById('trackTitleSa');
const trackTitleEn = document.getElementById('trackTitleEn');
const volumeSlider = document.getElementById('volumeSlider');
const waveformCanvas = document.getElementById('waveformCanvas');
const waveformContainer = document.getElementById('waveformContainer');
const ctx = waveformCanvas.getContext('2d');

let animFrameId;
let analyser, dataArray;

function initAudioContext() {
  if (analyser) return;
  const ac = new (window.AudioContext || window.webkitAudioContext)();
  const source = ac.createMediaElementSource(audio);
  analyser = ac.createAnalyser();
  analyser.fftSize = 256;
  source.connect(analyser);
  analyser.connect(ac.destination);
  dataArray = new Uint8Array(analyser.frequencyBinCount);
}

function resizeCanvas() {
  const rect = waveformContainer.getBoundingClientRect();
  waveformCanvas.width = rect.width * window.devicePixelRatio;
  waveformCanvas.height = rect.height * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
}

function drawWaveform() {
  const w = waveformContainer.clientWidth;
  const h = waveformContainer.clientHeight;
  ctx.clearRect(0, 0, w, h);

  if (analyser && isPlaying) {
    analyser.getByteFrequencyData(dataArray);
  }

  const barCount = 80;
  const barWidth = w / barCount - 2;
  const centerY = h / 2;
  const progress = audio.duration ? audio.currentTime / audio.duration : 0;

  for (let i = 0; i < barCount; i++) {
    const x = i * (barWidth + 2);
    let barH;

    if (analyser && isPlaying && dataArray) {
      const dataIdx = Math.floor(i * dataArray.length / barCount);
      barH = (dataArray[dataIdx] / 255) * (h * 0.4) + 2;
    } else {
      const seed = Math.sin(i * 0.3) * 0.5 + Math.sin(i * 0.7) * 0.3 + Math.cos(i * 0.15) * 0.2;
      barH = Math.abs(seed) * h * 0.35 + 3;
    }

    const isPast = (i / barCount) <= progress;

    ctx.fillStyle = isPast ? 'rgba(212, 168, 84, 0.8)' : 'rgba(212, 168, 84, 0.2)';
    ctx.fillRect(x, centerY - barH / 2, barWidth, barH / 2);

    ctx.fillStyle = isPast ? 'rgba(212, 168, 84, 0.5)' : 'rgba(212, 168, 84, 0.12)';
    ctx.fillRect(x, centerY, barWidth, barH / 2);
  }

  if (audio.duration) {
    const px = progress * w;
    ctx.strokeStyle = 'rgba(232, 160, 49, 0.9)';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(px, 0);
    ctx.lineTo(px, h);
    ctx.stroke();
  }

  animFrameId = requestAnimationFrame(drawWaveform);
}

function renderTracklist() {
  const container = document.getElementById('tracklist');
  container.innerHTML = TRACKS.map((t, i) => `
    <div class="track-item ${i === currentTrackIdx ? 'active' : ''} ${i === currentTrackIdx && isPlaying ? 'is-playing' : ''}"
         data-idx="${i}" onclick="selectTrack(${i})">
      <div class="track-idx">
        <span class="track-idx-text">${String(t.id).padStart(2, '0')}</span>
        <div class="playing-indicator">
          <div class="playing-bar"></div>
          <div class="playing-bar"></div>
          <div class="playing-bar"></div>
          <div class="playing-bar"></div>
        </div>
      </div>
      <div class="track-info">
        <div class="track-name-sa">${t.titleSa}</div>
        <div class="track-name-en">${t.titleEn}</div>
      </div>
      <div class="track-veda">${t.veda}</div>
      <div class="track-dur">${t.duration}</div>
    </div>
  `).join('');
}

function formatTime(s) {
  if (!s || isNaN(s)) return '0:00';
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return m + ':' + sec.toString().padStart(2, '0');
}

function loadTrack(idx) {
  currentTrackIdx = idx;
  const track = TRACKS[idx];
  trackNumber.textContent = 'Track ' + (idx + 1) + ' of ' + TRACKS.length;
  trackTitleSa.textContent = track.titleSa;
  trackTitleEn.textContent = track.titleEn;

  if (track.src) {
    audio.src = track.src;
    audio.load();
  } else {
    audio.removeAttribute('src');
    audio.load();
  }

  currentTimeEl.textContent = '0:00';
  totalTimeEl.textContent = track.duration;
  renderTracklist();
}

function togglePlay() {
  const track = TRACKS[currentTrackIdx];
  if (!track.src) return;
  if (!analyser) initAudioContext();

  if (isPlaying) {
    audio.pause();
    isPlaying = false;
  } else {
    audio.play();
    isPlaying = true;
  }
  updatePlayState();
}

function updatePlayState() {
  playIcon.style.display = isPlaying ? 'none' : 'block';
  pauseIcon.style.display = isPlaying ? 'block' : 'none';
  playBtn.classList.toggle('playing', isPlaying);
  renderTracklist();
}

function selectTrack(idx) {
  const wasPlaying = isPlaying;
  if (isPlaying) { audio.pause(); isPlaying = false; }
  loadTrack(idx);
  const track = TRACKS[idx];
  if (track.src) {
    if (!analyser) initAudioContext();
    audio.play().then(() => { isPlaying = true; updatePlayState(); }).catch(() => {});
  }
  updatePlayState();
}

function playNext() {
  let next = currentTrackIdx + 1;
  if (next >= TRACKS.length) next = 0;
  selectTrack(next);
}

function playPrev() {
  if (audio.currentTime > 3) { audio.currentTime = 0; return; }
  let prev = currentTrackIdx - 1;
  if (prev < 0) prev = TRACKS.length - 1;
  selectTrack(prev);
}

playBtn.addEventListener('click', togglePlay);
nextBtn.addEventListener('click', playNext);
prevBtn.addEventListener('click', playPrev);
rewindBtn.addEventListener('click', () => { audio.currentTime = Math.max(0, audio.currentTime - 10); });
forwardBtn.addEventListener('click', () => { audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 10); });

repeatBtn.addEventListener('click', () => {
  isRepeat = !isRepeat;
  repeatBtn.classList.toggle('active', isRepeat);
  audio.loop = isRepeat;
});

volumeSlider.addEventListener('input', (e) => { audio.volume = e.target.value / 100; });
audio.volume = 0.8;

document.querySelectorAll('.speed-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    audio.playbackRate = parseFloat(btn.dataset.speed);
  });
});

audio.addEventListener('timeupdate', () => { currentTimeEl.textContent = formatTime(audio.currentTime); });
audio.addEventListener('loadedmetadata', () => { totalTimeEl.textContent = formatTime(audio.duration); });
audio.addEventListener('ended', () => { if (!isRepeat) { isPlaying = false; updatePlayState(); playNext(); } });
audio.addEventListener('pause', () => { isPlaying = false; updatePlayState(); });
audio.addEventListener('play', () => { isPlaying = true; updatePlayState(); });

waveformContainer.addEventListener('click', (e) => {
  if (!audio.duration) return;
  const rect = waveformContainer.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  audio.currentTime = pct * audio.duration;
});

document.addEventListener('keydown', (e) => {
  if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
  if (e.code === 'ArrowRight') { audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 5); }
  if (e.code === 'ArrowLeft') { audio.currentTime = Math.max(0, audio.currentTime - 5); }
});

window.addEventListener('resize', resizeCanvas);
resizeCanvas();
loadTrack(0);
drawWaveform();

/* ═══════════════════════════════════════════════════════════
   ANALYSIS ENGINE — Record / Upload / Playback / Submit
   ═══════════════════════════════════════════════════════════ */

// ── DOM refs ──
const aInputCard    = document.getElementById('a-input-card');
const aSettingsCard = document.getElementById('a-settings-card');
const aProcCard     = document.getElementById('a-proc-card');
const aResultsCard  = document.getElementById('a-results-card');
const aBtnRecord    = document.getElementById('a-btn-record');
const aBtnStop      = document.getElementById('a-btn-stop');
const aFileInput    = document.getElementById('a-file-input');
const aRecBar       = document.getElementById('a-rec-bar');
const aRecTimer     = document.getElementById('a-rec-timer');
const aStatus       = document.getElementById('a-status');
const aWaveformCvs  = document.getElementById('a-waveform');
const aWaveCtx      = aWaveformCvs.getContext('2d');
const aBtnSubmit    = document.getElementById('a-btn-submit');
const aBtnDiscard   = document.getElementById('a-btn-discard');
const aBtnNew       = document.getElementById('a-btn-new');
const aProgressFill = document.getElementById('a-progress-fill');
const aProcMsg      = document.getElementById('a-proc-msg');
const aSaSelect     = document.getElementById('a-sa');
const aAlgoSelect   = document.getElementById('a-algo');
const aScriptSelect = document.getElementById('a-script');

// ── State ──
let analysisBlob = null;       // Blob of audio to analyse
let analysisBlobName = null;   // filename for the upload
let mediaRecorder = null;
let recordedChunks = [];
let recStream = null;
let recStartTime = 0;
let recTimerInterval = null;
let recAnalyser = null;
let recDataArray = null;
let recAnimFrame = null;
const MAX_REC_S = 30;

// ── Swara colour palette ──
const SWARA_COLORS = {
  Sa: '#d4a854', Ri1: '#e87831', Ri2: '#e8a031', Ga1: '#c4607a', Ga2: '#c07090',
  Ma1: '#4a8fb8', Ma2: '#5a9fc8', Pa: '#d4a854', Dha1: '#a060c0', Dha2: '#b070d0',
  Ni1: '#60a0a0', Ni2: '#70b0b0',
};
const GAMAKA_COLORS = {
  kampita: '#d4a854', jaru: '#4a8fb8', sphuritam: '#c4607a', nokku: '#e87831',
  odukkal: '#60a0a0', orikkai: '#a060c0', ravai: '#e8a031', khandippu: '#b070d0',
  flat: '#9a8e7e',
};

// ── Load tuning presets into <select> ──
(async function loadPresets() {
  try {
    const res = await fetch('/api/v1/tuning-presets');
    if (!res.ok) throw new Error(res.statusText);
    const presets = await res.json();
    aSaSelect.innerHTML = presets.map(p =>
      `<option value="${p.reference_sa_hz}">${p.description} (${p.reference_sa_hz} Hz)</option>`
    ).join('');
  } catch {
    aSaSelect.innerHTML = '<option value="261.63">C4 — 261.63 Hz</option>';
  }
})();

// ══════════════ RECORDER ══════════════

function setAnalysisState(state) {
  // state: 'idle' | 'recording' | 'captured' | 'processing' | 'results'
  aInputCard.style.display    = (state === 'idle' || state === 'recording') ? '' : 'none';
  aSettingsCard.style.display = (state === 'captured') ? '' : 'none';
  aProcCard.style.display     = (state === 'processing') ? '' : 'none';
  aResultsCard.style.display  = (state === 'results') ? '' : 'none';

  aBtnRecord.disabled = (state === 'recording');
  aBtnStop.disabled   = (state !== 'recording');
  aRecBar.classList.toggle('active', state === 'recording');

  if (state === 'idle') {
    analysisBlob = null;
    analysisBlobName = null;
    aStatus.textContent = '';
    aStatus.classList.remove('a-error');
  }
}

async function startRecording() {
  try {
    recStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch (err) {
    showAnalysisError('Microphone access denied. Please allow microphone in your browser settings.');
    return;
  }

  recordedChunks = [];
  const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
    ? 'audio/webm;codecs=opus' : 'audio/webm';
  mediaRecorder = new MediaRecorder(recStream, { mimeType });

  mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
  mediaRecorder.onstop = () => finishRecording();

  mediaRecorder.start(250); // collect chunks every 250ms
  recStartTime = Date.now();
  setAnalysisState('recording');
  aBtnRecord.classList.add('is-recording');

  // Timer display
  recTimerInterval = setInterval(() => {
    const elapsed = (Date.now() - recStartTime) / 1000;
    aRecTimer.textContent = elapsed.toFixed(1) + ' s';
    if (elapsed >= MAX_REC_S) stopRecording();
  }, 100);

  // Live waveform
  const ac = new (window.AudioContext || window.webkitAudioContext)();
  const src = ac.createMediaStreamSource(recStream);
  recAnalyser = ac.createAnalyser();
  recAnalyser.fftSize = 256;
  src.connect(recAnalyser);
  recDataArray = new Uint8Array(recAnalyser.frequencyBinCount);
  drawRecWaveform();
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  clearInterval(recTimerInterval);
  aBtnRecord.classList.remove('is-recording');
  if (recStream) { recStream.getTracks().forEach(t => t.stop()); recStream = null; }
  cancelAnimationFrame(recAnimFrame);
}

function finishRecording() {
  const blob = new Blob(recordedChunks, { type: 'audio/webm' });
  if (blob.size < 500) {
    showAnalysisError('Recording too short. Try again.');
    setAnalysisState('idle');
    return;
  }
  analysisBlob = blob;
  analysisBlobName = 'recording.webm';
  loadBlobIntoPlayer(blob, 'Your Recording');
  setAnalysisState('captured');
  aStatus.textContent = `Recording captured (${(blob.size / 1024).toFixed(0)} KB). Listen back, then submit.`;
}

function drawRecWaveform() {
  const w = aWaveformCvs.width;
  const h = aWaveformCvs.height;
  aWaveCtx.clearRect(0, 0, w, h);

  if (recAnalyser) recAnalyser.getByteTimeDomainData(recDataArray);

  aWaveCtx.strokeStyle = '#e07070';
  aWaveCtx.lineWidth = 1.5;
  aWaveCtx.beginPath();
  const sliceW = w / (recDataArray ? recDataArray.length : 128);
  for (let i = 0; i < (recDataArray ? recDataArray.length : 128); i++) {
    const v = recDataArray ? recDataArray[i] / 128.0 : 1;
    const y = (v * h) / 2;
    if (i === 0) aWaveCtx.moveTo(0, y);
    else aWaveCtx.lineTo(i * sliceW, y);
  }
  aWaveCtx.stroke();
  recAnimFrame = requestAnimationFrame(drawRecWaveform);
}

function showAnalysisError(msg) {
  aStatus.textContent = msg;
  aStatus.classList.add('a-error');
}

// ══════════════ FILE UPLOAD ══════════════

aFileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  if (file.size > 10 * 1024 * 1024) {
    showAnalysisError('File too large (max 10 MB).');
    return;
  }

  analysisBlob = file;
  analysisBlobName = file.name;
  loadBlobIntoPlayer(file, file.name);
  setAnalysisState('captured');
  aStatus.textContent = `File loaded: ${file.name} (${(file.size / 1024).toFixed(0)} KB). Listen back, then submit.`;
  aFileInput.value = ''; // reset for re-upload
});

// ══════════════ LOAD INTO PLAYER ══════════════

function loadBlobIntoPlayer(blob, label) {
  const url = URL.createObjectURL(blob);

  // Add as a dynamic track in the player
  const dynTrack = {
    id: TRACKS.length + 1,
    titleSa: '\u{1F3B5} ' + label,
    titleEn: label,
    veda: 'Analysis',
    src: url,
    duration: '—',
    _isAnalysis: true,
  };

  // Remove any previous analysis track
  const prevIdx = TRACKS.findIndex(t => t._isAnalysis);
  if (prevIdx >= 0) {
    URL.revokeObjectURL(TRACKS[prevIdx].src);
    TRACKS.splice(prevIdx, 1);
  }

  TRACKS.push(dynTrack);
  const idx = TRACKS.length - 1;
  selectTrack(idx);

  // Scroll to player
  document.querySelector('.player-section').scrollIntoView({ behavior: 'smooth' });
}

// ══════════════ SUBMIT FOR ANALYSIS ══════════════

aBtnSubmit.addEventListener('click', async () => {
  if (!analysisBlob) return;

  setAnalysisState('processing');
  const progress = (pct, msg) => {
    aProgressFill.style.width = pct + '%';
    aProcMsg.textContent = msg;
  };

  progress(10, 'Uploading audio\u2026');

  const formData = new FormData();
  formData.append('file', analysisBlob, analysisBlobName || 'audio.webm');
  formData.append('reference_sa_hz', aSaSelect.value);
  formData.append('algorithm', aAlgoSelect.value);
  formData.append('script', aScriptSelect.value);
  formData.append('include_contour', 'true');
  formData.append('tolerance_cents', '40');

  progress(20, 'Detecting pitch\u2026');

  try {
    const res = await fetch('/api/v1/analyze', { method: 'POST', body: formData });
    progress(60, 'Processing swaras\u2026');

    if (!res.ok) {
      const err = await res.json().catch(() => ({ detail: res.statusText }));
      throw new Error(err.detail || 'Analysis failed');
    }

    progress(80, 'Identifying raga\u2026');
    const data = await res.json();
    progress(100, 'Rendering results\u2026');

    // Small delay so user sees 100%
    await new Promise(r => setTimeout(r, 400));
    renderAnalysisResults(data);
    setAnalysisState('results');
  } catch (err) {
    setAnalysisState('captured');
    showAnalysisError('Analysis failed: ' + err.message);
  }
});

// ══════════════ RENDER RESULTS ══════════════

function renderAnalysisResults(data) {
  // Summary
  const summaryEl = document.getElementById('a-summary');
  summaryEl.innerHTML = `
    <div class="a-summary">
      <div class="a-sum-item">
        <span class="a-sum-label">Duration</span>
        <span class="a-sum-value">${data.duration_s.toFixed(1)}s</span>
      </div>
      <div class="a-sum-item">
        <span class="a-sum-label">Algorithm</span>
        <span class="a-sum-value">${data.algorithm.toUpperCase()}</span>
      </div>
      <div class="a-sum-item">
        <span class="a-sum-label">Swaras Found</span>
        <span class="a-sum-value">${data.unique_swaras.length}</span>
      </div>
      <div class="a-sum-item">
        <span class="a-sum-label">Top Raga</span>
        <span class="a-sum-value" style="font-size:0.85rem">${data.raga_candidates.length ? data.raga_candidates[0].raga_name : '—'}</span>
      </div>
    </div>`;

  // Compact notation
  document.getElementById('a-notation-compact').innerHTML =
    `<pre class="a-notation-pre">${escHtml(data.notation_compact)}</pre>`;

  // Full notation
  document.getElementById('a-notation-full').innerHTML =
    `<pre class="a-notation-pre">${escHtml(data.notation_requested)}</pre>`;

  // Phrases
  const phrasesEl = document.getElementById('a-phrases');
  if (data.phrases.length === 0) {
    phrasesEl.innerHTML = '<p style="color:var(--text-muted);font-style:italic">No phrases detected.</p>';
  } else {
    phrasesEl.innerHTML = data.phrases.map((p, i) => {
      const notesHtml = p.notes.map(n => {
        const color = SWARA_COLORS[n.swara_id] || 'var(--text-light)';
        const octClass = n.octave === 0 ? 'oct-low' : n.octave === 2 ? 'oct-high' : '';
        return `<span class="a-swara ${octClass}" style="color:${color};border-color:${color}">
          ${escHtml(n.swara_id)}
          <span class="a-tip">${n.frequency_hz} Hz &middot; ${n.cents_deviation > 0 ? '+' : ''}${n.cents_deviation}\u00A2</span>
        </span>`;
      }).join('');
      return `<div class="a-phrase">
        <div class="a-phrase-hdr">Phrase ${i + 1} &mdash; ${(p.start_ms / 1000).toFixed(1)}s \u2013 ${(p.end_ms / 1000).toFixed(1)}s</div>
        <div class="a-phrase-notes">${notesHtml}</div>
      </div>`;
    }).join('');
  }

  // Ragas
  const ragasEl = document.getElementById('a-ragas');
  if (data.raga_candidates.length === 0) {
    ragasEl.innerHTML = '<p style="color:var(--text-muted);font-style:italic">No raga candidates matched.</p>';
  } else {
    ragasEl.innerHTML = data.raga_candidates.map((r, i) => {
      const rankClass = i < 3 ? `a-raga-rank--${i + 1}` : 'a-raga-rank--n';
      const pct = (r.confidence * 100).toFixed(0);
      return `<div class="a-raga">
        <div class="a-raga-rank ${rankClass}">${i + 1}</div>
        <div>
          <span class="a-raga-name">${escHtml(r.raga_name)}</span>
          <span class="a-raga-num">#${r.raga_number}</span>
        </div>
        <div class="a-conf-bar"><div class="a-conf-fill" style="width:${pct}%"></div></div>
        <div class="a-conf-pct">${pct}%</div>
        <div class="a-raga-scale">\u2191 ${r.arohana.join(' ')} &nbsp;&nbsp; \u2193 ${r.avarohana.join(' ')}</div>
      </div>`;
    }).join('');
  }

  // Gamakas
  const gamakasEl = document.getElementById('a-gamakas');
  const gamakaMap = {};
  data.gamakas.forEach(g => {
    if (!gamakaMap[g.gamaka_type]) gamakaMap[g.gamaka_type] = 0;
    gamakaMap[g.gamaka_type]++;
  });
  const gamakaEntries = Object.entries(gamakaMap).sort((a, b) => b[1] - a[1]);
  if (gamakaEntries.length === 0) {
    gamakasEl.innerHTML = '<p style="color:var(--text-muted);font-style:italic">No gamakas detected.</p>';
  } else {
    gamakasEl.innerHTML = `<div class="a-gamaka-row">` + gamakaEntries.map(([type, count]) => {
      const color = GAMAKA_COLORS[type] || '#9a8e7e';
      return `<div class="a-gamaka-item">
        <span class="a-gamaka-dot" style="background:${color}"></span>
        <span class="a-gamaka-name">${capitalize(type)}</span>
        <span class="a-gamaka-count">&times;${count}</span>
      </div>`;
    }).join('') + `</div>`;
  }

  // Contour
  if (data.pitch_contour && data.pitch_contour.length > 0) {
    renderContour(data.pitch_contour, data.reference_sa_hz);
  }
}

// ── Pitch contour canvas ──
function renderContour(frames, saHz) {
  const canvas = document.getElementById('a-contour');
  const ctx2 = canvas.getContext('2d');
  const W = canvas.width;
  const H = canvas.height;
  ctx2.clearRect(0, 0, W, H);

  const pad = { top: 10, bottom: 20, left: 40, right: 10 };
  const plotW = W - pad.left - pad.right;
  const plotH = H - pad.top - pad.bottom;

  // Determine time range and freq range
  const maxTime = frames[frames.length - 1].timestamp_ms;
  const validFrames = frames.filter(f => f.frequency_hz > 30);
  if (validFrames.length === 0) return;

  const freqs = validFrames.map(f => f.frequency_hz);
  const minF = Math.min(...freqs) * 0.85;
  const maxF = Math.max(...freqs) * 1.15;

  const toX = t => pad.left + (t / maxTime) * plotW;
  const toY = f => pad.top + plotH - ((f - minF) / (maxF - minF)) * plotH;

  // Background grid
  ctx2.strokeStyle = 'rgba(212,168,84,0.06)';
  ctx2.lineWidth = 0.5;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (i / 4) * plotH;
    ctx2.beginPath(); ctx2.moveTo(pad.left, y); ctx2.lineTo(W - pad.right, y); ctx2.stroke();
  }

  // Sa reference line
  if (saHz >= minF && saHz <= maxF) {
    ctx2.strokeStyle = 'rgba(212,168,84,0.35)';
    ctx2.lineWidth = 1;
    ctx2.setLineDash([4, 4]);
    const sy = toY(saHz);
    ctx2.beginPath(); ctx2.moveTo(pad.left, sy); ctx2.lineTo(W - pad.right, sy); ctx2.stroke();
    ctx2.setLineDash([]);
    ctx2.fillStyle = 'rgba(212,168,84,0.5)';
    ctx2.font = '9px Cinzel, serif';
    ctx2.fillText('Sa', pad.left - 18, sy + 3);
  }

  // Plot pitch contour
  ctx2.lineWidth = 1.5;
  ctx2.beginPath();
  let started = false;
  for (const f of frames) {
    if (f.frequency_hz < 30 || f.confidence < 0.2) {
      started = false;
      continue;
    }
    const x = toX(f.timestamp_ms);
    const y = toY(f.frequency_hz);
    if (!started) { ctx2.moveTo(x, y); started = true; }
    else ctx2.lineTo(x, y);
  }
  ctx2.strokeStyle = 'rgba(212,168,84,0.8)';
  ctx2.stroke();

  // Confidence-shaded dots
  for (const f of validFrames) {
    if (f.confidence < 0.2) continue;
    const x = toX(f.timestamp_ms);
    const y = toY(f.frequency_hz);
    ctx2.fillStyle = `rgba(212,168,84,${f.confidence * 0.6})`;
    ctx2.beginPath();
    ctx2.arc(x, y, 1.5, 0, Math.PI * 2);
    ctx2.fill();
  }

  // Time axis labels
  ctx2.fillStyle = 'rgba(154,142,126,0.6)';
  ctx2.font = '8px Cinzel, serif';
  for (let t = 0; t <= maxTime; t += Math.max(1000, Math.floor(maxTime / 6 / 1000) * 1000)) {
    ctx2.fillText((t / 1000).toFixed(0) + 's', toX(t) - 5, H - 4);
  }
}

// ══════════════ TAB SWITCHING ══════════════

document.getElementById('a-tabs').addEventListener('click', (e) => {
  const tab = e.target.closest('.a-tab');
  if (!tab) return;
  document.querySelectorAll('.a-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.a-panel').forEach(p => p.classList.remove('active'));
  tab.classList.add('active');
  document.getElementById(tab.dataset.panel).classList.add('active');
});

// ══════════════ BUTTON WIRING ══════════════

aBtnRecord.addEventListener('click', startRecording);
aBtnStop.addEventListener('click', stopRecording);

aBtnDiscard.addEventListener('click', () => {
  // Remove analysis track from player
  const idx = TRACKS.findIndex(t => t._isAnalysis);
  if (idx >= 0) {
    URL.revokeObjectURL(TRACKS[idx].src);
    TRACKS.splice(idx, 1);
    if (currentTrackIdx >= TRACKS.length) currentTrackIdx = 0;
    loadTrack(currentTrackIdx);
  }
  setAnalysisState('idle');
});

aBtnNew.addEventListener('click', () => {
  // Remove analysis track
  const idx = TRACKS.findIndex(t => t._isAnalysis);
  if (idx >= 0) {
    URL.revokeObjectURL(TRACKS[idx].src);
    TRACKS.splice(idx, 1);
    if (currentTrackIdx >= TRACKS.length) currentTrackIdx = 0;
    loadTrack(currentTrackIdx);
  }
  setAnalysisState('idle');
  document.getElementById('analyze-section').scrollIntoView({ behavior: 'smooth' });
});

// ══════════════ UTILS ══════════════

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

// Initialize in idle state
setAnalysisState('idle');

// ══════════════ SPLASH SCREEN ══════════════

const splashOverlay = document.getElementById('splashOverlay');
const splashEnter   = document.getElementById('splashEnter');

function dismissSplash() {
  if (splashOverlay.classList.contains('dismiss')) return;
  splashOverlay.classList.add('dismiss');
  document.querySelector('.page-wrapper').classList.add('revealed');
  setTimeout(() => { splashOverlay.style.display = 'none'; }, 900);
}

splashEnter.addEventListener('click', dismissSplash);

// Also dismiss on any key press or tap after the button appears
setTimeout(() => {
  const dismissOnce = () => {
    dismissSplash();
    document.removeEventListener('keydown', dismissOnce);
  };
  document.addEventListener('keydown', dismissOnce);
}, 2600);

// Auto-dismiss after 6 seconds if user doesn't click
setTimeout(dismissSplash, 6000);
</script>

</body>
</html>
